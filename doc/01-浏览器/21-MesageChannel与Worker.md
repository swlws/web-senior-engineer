# MessageChannel ä¸ Worker

ä»åŸç†ã€ç”¨é€”ã€æ€§èƒ½å¼€é”€æ¥åˆ†æ MessageChannel å’Œ Web Worker çš„æ€§èƒ½å·®å¼‚ã€‚æ³¨æ„ï¼Œè¿™é‡Œè¦åˆ†æ¸…æ¥šæ¦‚å¿µï¼šMessageChannel æ˜¯é€šä¿¡é€šé“ï¼Œè€Œ Worker æ˜¯è¿è¡Œä¸Šä¸‹æ–‡ï¼Œä¸¤è€…æœ‰äº¤é›†ä½†ä¾§é‡ç‚¹ä¸åŒã€‚

## åŸç†å¯¹æ¯”

| ç‰¹æ€§     | MessageChannel                               | Web Worker                                                      |
| -------- | -------------------------------------------- | --------------------------------------------------------------- |
| æ ¸å¿ƒ     | æµè§ˆå™¨å†…éƒ¨ **åŒå‘æ¶ˆæ¯é€šé“**ï¼ˆport1 â†” port2ï¼‰ | **ç‹¬ç«‹çº¿ç¨‹**è¿è¡Œ JSï¼Œä¸»çº¿ç¨‹ä¸ä¼šé˜»å¡                             |
| æ•°æ®ä¼ è¾“ | é€šè¿‡ `postMessage`ï¼Œä½¿ç”¨ **ç»“æ„åŒ–å…‹éš†**      | åŒæ ·ç”¨ `postMessage` ä¼ é€’æ•°æ®ï¼Œæ”¯æŒ Transferable å¯¹è±¡ï¼ˆé›¶æ‹·è´ï¼‰ |
| å¹¶å‘     | çº¿ç¨‹å†…å¼‚æ­¥é˜Ÿåˆ—ï¼Œç«¯å£æ¶ˆæ¯ä¾èµ–äº‹ä»¶å¾ªç¯         | çœŸæ­£å¹¶è¡Œçº¿ç¨‹ï¼ŒCPU å¯†é›†å‹ä»»åŠ¡ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹                      |
| ä½¿ç”¨åœºæ™¯ | iframe â†” iframeï¼Œworker â†” ä¸»çº¿ç¨‹ï¼Œç‚¹å¯¹ç‚¹é€šä¿¡ | CPU å¯†é›†è®¡ç®—ã€å¤§æ•°æ®å¤„ç†ã€é•¿æœŸè¿è¡Œä»»åŠ¡                          |

## 2ï¸âƒ£ æ€§èƒ½è€ƒè™‘

### â‘  æ•°æ®é‡å°ã€é€šä¿¡é¢‘ç¹

- MessageChannel åœ¨åŒä¸€çº¿ç¨‹å†…é€šä¿¡ï¼ˆå¦‚æœæ˜¯åŒä¸€çº¿ç¨‹çš„ port1 â†” port2ï¼‰ï¼Œæ¶ˆæ¯å¼€é”€éå¸¸å°ï¼Œå»¶è¿Ÿä½ï¼Œå‡ ä¹æ˜¯â€œé›¶æ‹·è´â€ã€‚
- Worker ä¹Ÿå¯ä»¥ç”¨ postMessageï¼Œä½†æ˜¯è·¨çº¿ç¨‹ä¼šæ¶‰åŠ çº¿ç¨‹é—´æ¶ˆæ¯åºåˆ—åŒ–/å…‹éš†ï¼Œé™¤éä½¿ç”¨ Transferable å¯¹è±¡ï¼Œå¦åˆ™å¼€é”€æ¯”å•çº¿ç¨‹ port é«˜ã€‚

ç»“è®ºï¼šæ•°æ®é‡å°ã€é¢‘ç¹é€šä¿¡ â†’ MessageChannel æ›´å¿«ã€‚

### â‘¡ CPU å¯†é›†ä»»åŠ¡

- MessageChannel åªæ˜¯é€šä¿¡é€šé“ï¼Œæœ¬èº«ä¸ä¼šå¸¦æ¥çº¿ç¨‹å¹¶è¡Œæ•ˆæœã€‚
- Worker å¯ä»¥æŠŠè®¡ç®—ä»»åŠ¡ç§»åˆ°ç‹¬ç«‹çº¿ç¨‹ï¼Œä¸é˜»å¡ UIã€‚

ç»“è®ºï¼šCPU å¯†é›†è®¡ç®— â†’ Worker æ›´å¥½ã€‚

### â‘¢ å¤§æ•°æ®ä¼ è¾“

- å¦‚æœéœ€è¦ä¼ è¾“ ArrayBuffer æˆ– Blobï¼š
  - postMessage é»˜è®¤æ˜¯æ‹·è´ï¼ˆcloneï¼‰ï¼Œæ€§èƒ½å¼€é”€å¤§ã€‚
  - å¯ä»¥ä½¿ç”¨ Transferable å¯¹è±¡ï¼ˆArrayBufferï¼‰åšåˆ°é›¶æ‹·è´ã€‚
- Worker + Transferable = æœ€ä¼˜å¤§æ•°æ®ä¼ è¾“
- MessageChannel + Transferable = åŒæ ·å¯ä»¥é›¶æ‹·è´

## 3ï¸âƒ£ ç»“åˆä½¿ç”¨åœºæ™¯

| åœºæ™¯                          | æ¨è                                                 |
| ----------------------------- | ---------------------------------------------------- |
| iframe â†” iframeã€è½»é‡æ¶ˆæ¯     | MessageChannel                                       |
| Worker â†” ä¸»çº¿ç¨‹ã€CPU å¯†é›†ä»»åŠ¡ | Web Workerï¼ˆå¯ä»¥åŒæ—¶ç”¨ MessageChannel å»ºç«‹ä¸“ç”¨é€šé“ï¼‰ |
| RPC / ç‚¹å¯¹ç‚¹é€šä¿¡              | MessageChannel + Worker/iframe                       |
| å¤§æ•°æ®å¤„ç† / å¤šçº¿ç¨‹           | Worker + Transferable + MessageChannel               |

## ğŸ”‘ ç»“è®ºï¼š

- æ¶ˆæ¯é¢‘ç¹ã€è½»é‡ â†’ MessageChannel
- è®¡ç®—å¯†é›† â†’ Worker
- ä¸¤è€…å¯ä»¥ç»“åˆä½¿ç”¨ï¼šWorker å†…éƒ¨å¼€ MessageChannel åš RPC é€šé“ï¼Œæ—¢é«˜æ€§èƒ½åˆå¹²å‡€ã€‚
