# React Fiber

React Fiber æ˜¯ React 16 å¼•å…¥çš„ä¸€ç§ å…¨æ–°çš„æ ¸å¿ƒæ¶æ„ï¼Œç”¨äº é«˜æ•ˆç®¡ç†å’Œè°ƒåº¦ UI æ¸²æŸ“ã€‚å®ƒæ˜¯å¯¹æ—§æ¶æ„çš„å½»åº•é‡å†™ï¼Œç›®çš„æ˜¯å®ç°ä»¥ä¸‹ä¸‰ä¸ªç›®æ ‡ï¼š

## ğŸ¯ React Fiber çš„æ ¸å¿ƒç›®æ ‡

| ç›®æ ‡               | è¯´æ˜                               |
| ---------------- | -------------------------------- |
| âœ… **å¯ä¸­æ–­æ¸²æŸ“**      | é¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ï¼Œæå‡å“åº”æ€§                 |
| âœ… **ä¼˜å…ˆçº§è°ƒåº¦**      | æ›´é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆå¤„ç†                       |
| âœ… **å¢é‡æ¸²æŸ“**ï¼ˆæ—¶é—´åˆ‡ç‰‡ï¼‰ | æ¸²æŸ“ä»»åŠ¡æ‹†åˆ†æˆå°å—ï¼Œé€å¸§å¤„ç†                   |
| âœ… **å¼‚æ­¥å¯æ§æ¸²æŸ“**     | å¦‚ `Suspense`ã€`Concurrent Mode` ç­‰ |

## ğŸ§© Fiber æ˜¯ä»€ä¹ˆï¼Ÿ

> åœ¨ React ä¸­ï¼Œæ¯ä¸€ä¸ªç»„ä»¶å¯¹åº”ä¸€ä¸ª Fiber èŠ‚ç‚¹ã€‚

ä¸€ä¸ª Fiber æ˜¯ä¸€ä¸ª JS å¯¹è±¡ï¼ŒåŒ…å«ï¼š

```ts
type Fiber = {
  type: any;               // ç»„ä»¶ç±»å‹ï¼ˆå‡½æ•°/ç±»/hostï¼‰
  key: string | null;      // keyï¼Œç”¨äº diff ä¼˜åŒ–
  stateNode: any;          // å¯¹åº”çš„çœŸå® DOM æˆ–ç±»ç»„ä»¶å®ä¾‹
  return: Fiber | null;    // çˆ¶èŠ‚ç‚¹
  child: Fiber | null;     // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  sibling: Fiber | null;   // ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
  alternate: Fiber | null; // ä¸Šä¸€æ¬¡æ¸²æŸ“å¯¹åº”çš„ fiber
  effectTag: string;       // å‰¯ä½œç”¨æ ‡è®°ï¼ˆå¦‚æ–°å¢/åˆ é™¤ï¼‰
  ...
}
```

Fiber èŠ‚ç‚¹æ„æˆäº†ä¸€æ£µ Fiber æ ‘ï¼ˆè™šæ‹Ÿ DOM æ ‘çš„åº•å±‚å®ç°ï¼‰

## ğŸ”„ Fiber æ¶æ„æ¸²æŸ“æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

### é˜¶æ®µä¸€ï¼šrenderï¼ˆdiffï¼‰é˜¶æ®µ

- æ„å»º Fiber æ ‘ï¼Œæ‰¾å‡ºéœ€è¦å˜æ›´çš„éƒ¨åˆ†ï¼›
- å¯ä»¥è¢«ä¸­æ–­ï¼›
- æ¯ä¸ªèŠ‚ç‚¹æ”¶é›†å‰¯ä½œç”¨ï¼ˆeffectï¼‰ï¼›
- ä¸è§¦å‘ DOM æ“ä½œã€‚

```text
ReactDOM.render() â†’
  workLoop â†’ build fiber æ ‘ â†’ æ”¶é›† effect
```

### é˜¶æ®µäºŒï¼šcommitï¼ˆæäº¤ï¼‰é˜¶æ®µ

- æ‰§è¡Œ DOM æ“ä½œï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰ï¼›
- ä¸èƒ½ä¸­æ–­ï¼›
- è§¦å‘ useEffectã€ref å›è°ƒç­‰å‰¯ä½œç”¨ã€‚

```text
commitRoot() â†’
  beforeMutation â†’ mutation â†’ layout
```

## ğŸ§  Fiber çš„è®¾è®¡ä¼˜åŠ¿

| æ—§æ¶æ„ï¼ˆStack Reconcilerï¼‰ | Fiber æ¶æ„        |
| --------------------- | --------------- |
| é€’å½’å¤„ç†ç»„ä»¶                | å¾ªç¯ç»“æ„ï¼Œæ›´æ˜“ä¸­æ–­       |
| ä¸èƒ½ä¸­æ–­                  | å¯ä¸­æ–­ï¼Œå¯æ¢å¤         |
| æ— ä¼˜å…ˆçº§åŒºåˆ†                | æ¯ä¸ª Fiber èŠ‚ç‚¹æœ‰ä¼˜å…ˆçº§ |
| æ¯æ¬¡æ›´æ–°éƒ½é‡å»ºæ•´æ£µæ ‘            | Fiber æ ‘å¤ç”¨ï¼Œå¢é‡æ›´æ–°  |

## ğŸ•¸ï¸ Fiber èŠ‚ç‚¹ç»“æ„å›¾

```text
     <App />
       |
    FunctionComponent
       |
     HostComponent
     /          \
 <div>        <button>
```

æ¯ä¸ª JSX å…ƒç´  â†’ Fiber èŠ‚ç‚¹ â†’ é“¾æ¥å½¢æˆ Fiber æ ‘ï¼ˆ**å•é“¾æ ‘ç»“æ„ï¼šchild + sibling**ï¼‰

## ğŸ§µ ä¸ Scheduler åä½œ

Fiber æ¶æ„è®¾è®¡ä¹‹æ‰€ä»¥å¼ºå¤§ï¼Œæ˜¯å› ä¸ºå®ƒä¸ scheduler ååŒå·¥ä½œï¼Œå®ç°ä»¥ä¸‹è°ƒåº¦æœºåˆ¶ï¼š

- shouldYield()ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­ï¼Œé˜²æ­¢å¡é¡¿ï¼›
- æ¯æ¬¡æ¸²æŸ“å·¥ä½œåˆ‡æˆå°ä»»åŠ¡ï¼Œé€å¸§å¤„ç†ï¼›
- æŒ‰ä¼˜å…ˆçº§è°ƒåº¦ä¸åŒçš„æ›´æ–°ä»»åŠ¡ï¼ˆè¾“å…¥äº¤äº’ > å›¾ç‰‡åŠ è½½ > æ—¥å¿—æ”¶é›†ï¼‰ï¼›

## ğŸ”§ ç¤ºä¾‹ï¼šæ—¶é—´åˆ‡ç‰‡

```tsx
function App() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const start = performance.now();
    while (performance.now() - start < 100) {
      // æ¨¡æ‹Ÿé˜»å¡ä»»åŠ¡
    }
  }, [count]);

  return (
    <button onClick={() => setCount(c => c + 1)}>Add</button>
  );
}
```

åœ¨ React 18 å¹¶å‘æ¨¡å¼ä¸‹ï¼Œè¿™æ®µé˜»å¡é€»è¾‘å¯è¢«ä¸­æ–­ï¼Œä¸ä¼šå¡ UIã€‚

## ğŸ§¬ æ€»ç»“

| ç‰¹æ€§     | æ˜¯å¦å…·å¤‡ | è¯´æ˜                            |
| ------ | ---- | ----------------------------- |
| å¢é‡æ¸²æŸ“   | âœ…    | å°†æ›´æ–°ä»»åŠ¡æ‹†åˆ†ä¸ºå°å—å¤„ç†                  |
| å¯ä¸­æ–­    | âœ…    | ä¿æŒé¡µé¢å“åº”æµç•…                      |
| ä¼˜å…ˆçº§è°ƒåº¦  | âœ…    | é«˜ä¼˜ä»»åŠ¡å¯æŠ¢å ä½ä¼˜ä»»åŠ¡                   |
| å¤šé˜¶æ®µæäº¤  | âœ…    | before â†’ mutation â†’ layout    |
| å¹¶å‘ç‰¹æ€§æ”¯æŒ | âœ…    | æ”¯æŒ startTransitionã€Suspense ç­‰ |

## ğŸš€ æ¨èæ·±å…¥æ–¹å‘

- Fiber Tree çš„åˆ›å»ºè¿‡ç¨‹ï¼ˆReact.createElement â†’ beginWork â†’ completeWorkï¼‰
- effectList æ„å»ºä¸ commit é˜¶æ®µæ‰§è¡Œæœºåˆ¶
- React 18 å¹¶å‘ç‰¹æ€§ï¼ˆConcurrent Modeï¼‰çš„è°ƒåº¦åŸç†
