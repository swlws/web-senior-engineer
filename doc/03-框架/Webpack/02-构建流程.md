# Webpack 构建流程

Webpack 的构建流程分为 初始化、编译、构建、输出 等多个阶段，贯穿整个打包生命周期。

## 🧭 一图总览

```text
┌────────────┐
│ 初始化参数 │ 读取配置
└────┬───────┘
     ↓
┌────────────┐
│ 创建 Compiler 实例 │
└────┬─────────────┘
     ↓
┌────────────┐
│ 加载插件（执行 apply） │
└────┬─────────────┘
     ↓
┌────────────┐
│ 开始编译（调用 run） │
└────┬─────────────┘
     ↓
┌────────────┐
│ 确定入口（entry） │
└────┬─────────────┘
     ↓
┌────────────┐
│ 构建模块（make） │
│  - 解析依赖（递归） │
│  - 使用 loader │
└────┬─────────────┘
     ↓
┌────────────┐
│ 完成模块构建 │
└────┬─────────────┘
     ↓
┌────────────┐
│ 输出资源（emit） │
│  - 插件优化资源 │
└────┬─────────────┘
     ↓
┌────────────┐
│ 写入文件系统（dist） │
└────────────┘
```

## 🧱 构建流程详解

### 1. 初始化参数

- 读取 webpack.config.js
- 合并 CLI 参数、默认参数等，生成最终配置对象

### 2. 创建 Compiler 对象

- 调用 webpack(config) 生成 compiler 实例
- 该实例包含完整的生命周期钩子

### 3. 注册插件

- 调用每个插件的 apply(compiler) 方法
- 在不同阶段注册不同的事件钩子（基于 Tapable）

### 4. 开始编译（compiler.run()）

- 创建 compilation 对象，表示一次构建过程
- 准备资源、记录依赖图、调用插件钩子

### 5. 确定入口（entry）

- 从配置的 entry 出发，构建模块依赖图

### 6. 模块编译（make 阶段）

对于每个模块：

- 通过 Loader 处理资源
- 把源码转成 AST（抽象语法树）
- 找出依赖的模块（require, import）
- 递归处理子模块
- 转成 JS 模块对象并记录依赖关系（模块依赖图）

### 7. 模块优化与打包（seal 阶段）

- 根据模块依赖图，进行：
  - Tree Shaking
  - Scope Hoisting
  - SplitChunks 拆包优化
  - Chunk ID 分配等

### 8. 生成代码文件（emit 阶段）

- 将每个 Chunk 渲染成最终的 JS/CSS 文件
- 插件可以在此阶段修改内容（如注入 hash、替换占位符等）

### 9. 写入磁盘

- 将所有输出文件写入指定的输出目录（如 dist/）

## 🔁 生命周期钩子（部分）

| 钩子          | 时机                  |
| ------------- | --------------------- |
| `beforeRun`   | 编译前                |
| `run`         | 开始编译              |
| `compilation` | 创建 compilation 实例 |
| `make`        | 构建模块时            |
| `emit`        | 输出文件前            |
| `done`        | 构建完成              |

这些钩子为插件提供了扩展机制，是 Webpack 插件系统的核心。

## 📌 示例插件生命周期片段

```js
class MyPlugin {
  apply(compiler) {
    compiler.hooks.emit.tap("MyPlugin", (compilation) => {
      // 修改即将输出的资源
      compilation.assets["new.txt"] = {
        source: () => "hello world",
        size: () => 11,
      };
    });
  }
}
```

## 🧠 小结

Webpack 构建流程围绕 Compiler/Compilation 展开，流程包括：

| 阶段       | 说明                       |
| ---------- | -------------------------- |
| 配置初始化 | 读取配置，创建 Compiler    |
| 插件注入   | 注册生命周期钩子           |
| 编译构建   | 构建模块依赖图             |
| 优化处理   | Tree Shaking, Chunk 拆分等 |
| 输出生成   | 最终生成 JS/CSS/HTML 资源  |
