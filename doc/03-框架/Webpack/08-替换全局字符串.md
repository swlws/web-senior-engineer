# 替换全局字符串

在 webpack 构建过程中对所有源码进行“全局字符串替换”，最简单、最实用的方式有 三种：

## ✅ 方式一：使用 Webpack 官方 built-in 插件 DefinePlugin

适合 用变量替换字符串（但不支持正则替换）。

例如将代码中所有 "API_BASE_URL" 替换为 `"https://xxx.com"`

```js
new webpack.DefinePlugin({
  API_BASE_URL: JSON.stringify("https://xxx.com")
})
```

代码里可以写：

```js
fetch(`${API_BASE_URL}/user`)
```

⚠️ 局限：只做静态替换，不支持正则，不适合动态字符串匹配。

## ✅ 方式二：使用社区插件 `string-replace-webpack-plugin`（替换任意字符串）

- ✔ 支持正则
- ✔ 支持多规则
- ✔ 能替换所有 loader 处理后的最终代码

安装：

```bash
npm i string-replace-webpack-plugin -D
```

配置：

```js
const StringReplacePlugin = require("string-replace-webpack-plugin");

module.exports = {
  module: {
    rules: [
      {
        test: /\.(js|ts|vue)$/,
        loader: StringReplacePlugin.replace({
          replacements: [
            {
              pattern: /__VERSION__/g,
              replacement(match) {
                return "1.0.0";
              }
            },
            {
              pattern: /DEBUG_LOG\(.+?\)/g,
              replacement() {
                return "";
              }
            }
          ]
        })
      }
    ]
  },
  plugins: [new StringReplacePlugin()]
};
```

例：代码中 "__VERSION__" 会被替换成 "1.0.0"。

## ✅ 方式三：自己写一个最灵活的 Webpack 插件（推荐）

如果你想全局替换任意内容、甚至替换最终产物中的字符串，可以写一个十几行的插件，十分强大。

🔨 最小可用插件示例（对产物进行字符串替换）

Webpack5 写法

```js
class ReplaceTextPlugin {
  constructor(options) {
    this.options = options;
  }

  apply(compiler) {
    compiler.hooks.emit.tap("ReplaceTextPlugin", compilation => {
      const { rules } = this.options;

      for (const filename in compilation.assets) {
        let source = compilation.assets[filename].source();

        rules.forEach(rule => {
          source = source.replace(rule.from, rule.to);
        });

        compilation.assets[filename] = {
          source: () => source,
          size: () => source.length
        };
      }
    });
  }
}

module.exports = ReplaceTextPlugin;
```

使用：

```js
new ReplaceTextPlugin({
  rules: [
    { from: /__ENV__/g, to: "production" },
    { from: /console\.log\(.+?\);?/g, to: "" }
  ]
});
```

- ✔ 支持正则
- ✔ 替换所有最终构建产物（包括 JS/CSS/HTML）
- ✔ 自由度最高

## 🔍 三种方式如何选择？

| 场景                                  | 推荐方式                              |
| ----------------------------------- | --------------------------------- |
| 替换常量，如 `API_BASE_URL`、`APP_VERSION` | ✔ `DefinePlugin`                  |
| 替换源码中的正则、复杂语句片段                     | ✔ `string-replace-webpack-plugin` |
| 替换最终产物的字符串（如压缩后的 JS 中替换某些字符串）       | ✔ 自定义 ReplaceTextPlugin（方式三）      |
| 想对某些文件/loader 单独替换                  | ✔ loader 级别替换（方式二）                |
