# 微信小程序登录流程

## 一、概述

小程序登录本质：
前端用 `wx.login` 拿 临时 code → 传给服务端 → 服务端调用 微信接口换取 `openid / session_key` → 服务端生成 自己系统的登录态`（token / session）` → 返回给小程序，之后只认自家 token，不再依赖 code。

## 二、标准登录流程（时序）

```txt
小程序                业务服务端                 微信服务器
  |                      |                           |
  | wx.login()           |                           |
  |--------------------->|                           |
  |  code                |                           |
  |                      | jscode2session(code)      |
  |                      |-------------------------->|
  |                      | openid, session_key       |
  |                      |<--------------------------|
  |                      | 生成 token / session      |
  |  token               |                           |
  |<---------------------|                           |
```

## 三、每一步做了什么

### 1️⃣ 小程序端：wx.login

```js
wx.login({
  success(res) {
    const code = res.code
    // 发给业务服务端
  }
})
```

- 要点：
  - code 是：
    - 一次性
    - 5 分钟有效
  - 不能：
    - 本地解密用户信息
    - 本地直接当登录凭证

### 2️⃣ 服务端：换 openid / session_key

服务端调用微信接口：

```nginx
GET https://api.weixin.qq.com/sns/jscode2session
```

| 参数         | 说明                 |
| ---------- | ------------------ |
| appid      | 小程序 appid          |
| secret     | 小程序 secret         |
| js_code    | 前端传来的 code         |
| grant_type | authorization_code |

返回：

```json
{
  "openid": "o_xxx",
  "session_key": "xxx",
  "unionid": "xxx(可选)"
}
```

### 3️⃣ openid / unionid 是什么

| 字段          | 说明                         |
| ----------- | -------------------------- |
| openid      | **用户在当前小程序的唯一标识**          |
| unionid     | **同一微信开放平台下，跨小程序 / 公众号唯一** |
| session_key | **微信态会话密钥（短期）**            |

📌 关键：

- openid 才是真正的用户 ID
- session_key 不能返回给前端

### 4️⃣ 服务端建立“自己的登录态”

此时微信登录 已经结束，后续全是你系统的事。

服务端通常会：

```txt
openid → 查用户表
  存在 → 登录
  不存在 → 注册
```

然后生成：

- JWT Token（常见）
- 或 SessionId（少见）

返回给小程序：

```json
{
  "token": "xxxxx"
}
```

### 5️⃣ 小程序后续请求

```js
wx.request({
  url: '/api/user/info',
  header: {
    Authorization: 'Bearer ' + token
  }
})
```

## 四、获取用户信息（头像 / 昵称）

⚠️ 这是登录后的第二步，不是登录本身

新版流程（推荐）

```js
wx.getUserProfile({
  desc: '用于完善会员资料',
  success(res) {
    // avatarUrl / nickName
  }
})
```

- 必须用户点击触发
- 不再返回敏感信息（如手机号）

## 五、手机号登录（补充）

### 1️前端

```js
<button open-type="getPhoneNumber">获取手机号</button>
```

拿到：

```json
{
  "code": "phoneCode"
}
```

### 2️⃣ 服务端解密手机号

```txt
phoneCode + session_key
→ 调用微信接口
→ 得到手机号
```

⚠️ 必须配合 session_key 使用

## 总结

微信小程序登录是通过 wx.login 获取临时 code，
服务端使用该 code 调用微信 jscode2session 接口换取 openid 和 session_key，
再由服务端基于 openid 建立自己的用户体系并生成 token。
后续前端请求只携带业务 token，微信登录过程只在登录态失效时重新触发。
