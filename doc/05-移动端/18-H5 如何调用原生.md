# H5 å¦‚ä½•è°ƒç”¨åŸç”ŸåŠŸèƒ½

æŒ‰æ•´ä½“è®¤çŸ¥ â†’ schema â†’ JSBridge â†’ iOS / Android ç»†èŠ‚ â†’ å®‰å…¨ä¸å·¥ç¨‹å®è·µ â†’ é¢è¯•æ€»ç»“ ç»™ä½ ç³»ç»Ÿæ¢³ç†ä¸€éã€‚

## ä¸€ã€H5 è°ƒç”¨åŸç”Ÿçš„ä¸¤å¤§æ–¹å¼

åªæœ‰ä¸¤ç±»ï¼š

- URL Schemeï¼ˆæ‹¦æˆª URLï¼‰
- JSBridgeï¼ˆJS â†” Native é€šé“ï¼‰

| æ–¹å¼     | æœ¬è´¨        | é€‚åˆ           |
| -------- | ----------- | -------------- |
| schema   | ç”¨ URL è§¦å‘ | ç®€å•ã€ä¸€æ¬¡æ€§   |
| JSBridge | å‡½æ•°è°ƒç”¨    | å¤æ‚äº¤äº’ã€é«˜é¢‘ |

## äºŒã€Schema è°ƒç”¨åŸç”Ÿï¼ˆæœ€ç®€å•ï¼‰

### 1ï¸âƒ£ åŸç†

H5 å‘èµ·ä¸€æ¬¡ URL è¯·æ±‚ï¼ŒNative æ‹¦æˆªå¹¶è§£æ

```txt
js â†’ location.href / iframe.src
â†’ WebView shouldOverrideUrlLoading
â†’ Native æ‰§è¡Œé€»è¾‘
```

### 2ï¸âƒ£ H5 ç¤ºä¾‹

```js
location.href = "myapp://openPage?name=detail&id=123";
```

æˆ–æ›´ç¨³å¦¥çš„ï¼ˆä¸è·³è½¬é¡µé¢ï¼‰ï¼š

```js
const iframe = document.createElement("iframe");
iframe.src = "myapp://openPage?id=123";
iframe.style.display = "none";
document.body.appendChild(iframe);

setTimeout(() => iframe.remove(), 0);
```

### 3ï¸âƒ£ Native æ‹¦æˆª

Android

```java
@Override
public boolean shouldOverrideUrlLoading(
  WebView view, WebResourceRequest request) {
  Uri uri = request.getUrl();
  if ("myapp".equals(uri.getScheme())) {
    // æ‰§è¡ŒåŸç”Ÿé€»è¾‘
    return true;
  }
  return false;
}
```

iOS

```objc
- (BOOL)webView:(WKWebView *)webView
decidePolicyForNavigationAction:(WKNavigationAction *)action {
  NSURL *url = action.request.URL;
  if ([url.scheme isEqualToString:@"myapp"]) {
    // æ‰§è¡ŒåŸç”Ÿé€»è¾‘
    return NO;
  }
  return YES;
}
```

### 4ï¸âƒ£ Schema çš„ä¼˜ç¼ºç‚¹

- âœ… ä¼˜ç‚¹
  - å®ç°ç®€å•
  - ä¸ä¾èµ– JS æ³¨å…¥
  - å¯åŠ¨ App / æ‹‰èµ·é¡µé¢å¾ˆå¥½ç”¨
- âŒ ç¼ºç‚¹
  - æ— è¿”å›å€¼
  - URL é•¿åº¦å—é™
  - æ˜“è¢«æ‹¦æˆª / é£æ§
  - é«˜ç‰ˆæœ¬ iOS é™åˆ¶è·³è½¬
    ğŸ‘‰ ä¸é€‚åˆå¤æ‚äº¤äº’

## ä¸‰ã€JSBridgeï¼ˆå·¥ä¸šçº§æ ‡å‡†æ–¹æ¡ˆï¼‰

### 1ï¸âƒ£ æœ¬è´¨

Native å‘ WebView æ³¨å…¥ JS å¯¹è±¡ï¼ŒJS é€šè¿‡å®ƒè°ƒç”¨åŸç”Ÿæ–¹æ³•

```txt
JS â†’ window.Native.xxx()
â†’ Native æ‰§è¡Œ
â†’ å›è°ƒ JS
```

### 2ï¸âƒ£ H5 è°ƒç”¨ç¤ºä¾‹

```js
window.NativeBridge.call("openPage", { id: 123 }, (result) => {
  console.log(result);
});
```

### 3ï¸âƒ£ Android å®ç°ï¼ˆaddJavascriptInterfaceï¼‰

```java
webView.addJavascriptInterface(
  new Object() {
    @JavascriptInterface
    public void openPage(String params) {
      // æ‰§è¡ŒåŸç”Ÿé€»è¾‘
    }
  },
  "NativeBridge"
);
```

ğŸ“Œ Android 4.2+ æ‰å®‰å…¨

### 4ï¸âƒ£ iOS å®ç°ï¼ˆWKScriptMessageHandlerï¼‰

```js
window.webkit.messageHandlers.openPage.postMessage({
  id: 123,
});
```

```objc
- (void)userContentController:
  (WKUserContentController *)userContentController
  didReceiveScriptMessage:(WKScriptMessage *)message {
  // message.body
}
```

## å››ã€JSBridge çš„å®Œæ•´è®¾è®¡ï¼ˆé‡ç‚¹ï¼‰

### 1ï¸âƒ£ å¼‚æ­¥æ˜¯é»˜è®¤

```js
NativeBridge.call(method, params)
  .then(res => ...)
```

ğŸ‘‰ å› ä¸º Native æ˜¯å¼‚æ­¥çº¿ç¨‹

### 2ï¸âƒ£ é€šç”¨æ¡¥ç»“æ„ï¼ˆç¤ºæ„ï¼‰

```js
window.JSBridge = {
  call(method, params, callback) {
    const id = genId();
    callbacks[id] = callback;

    postMessage({
      method,
      params,
      callbackId: id,
    });
  },
};
```

### 3ï¸âƒ£ Native å›è°ƒ JS

```js
window.JSBridge.onCallback(id, result);
```

## äº”ã€Schema vs JSBridge å¯¹æ¯”æ€»ç»“

| ç»´åº¦     | Schema | JSBridge |
| -------- | ------ | -------- |
| è°ƒç”¨æ–¹å¼ | URL    | å‡½æ•°     |
| è¿”å›å€¼   | âŒ     | âœ…       |
| å¤æ‚äº¤äº’ | âŒ     | âœ…       |
| å¯é æ€§   | ä¸€èˆ¬   | é«˜       |
| ç»´æŠ¤æˆæœ¬ | ä½     | ä¸­       |

ğŸ‘‰ å®é™…é¡¹ç›®ï¼šä¸¤è€…é€šå¸¸åŒæ—¶å­˜åœ¨

## å…­ã€å®‰å…¨ & é£æ§ï¼ˆé«˜çº§åŠ åˆ†ï¼‰

- 1ï¸âƒ£ ç™½åå•æ ¡éªŒ
  - åªå…è®¸ç‰¹å®šåŸŸåè°ƒç”¨ bridge
- 2ï¸âƒ£ å‚æ•°æ ¡éªŒ
  - method / params åš schema æ ¡éªŒ
- 3ï¸âƒ£ ç¦ç”¨ eval / ä»»æ„ JS æ³¨å…¥

## ä¸ƒã€å·¥ç¨‹çº§æœ€ä½³å®è·µ

```js
// ç»Ÿä¸€å°è£…è°ƒç”¨æ–¹æ³•
export function callNative(method, params = {}) {
  if (window.JSBridge) {
    return window.JSBridge.call(method, params);
  }

  // fallback
  location.href = `myapp://${method}?data=${encodeURIComponent(
    JSON.stringify(params)
  )}`;
}
```

## å…«ã€æ€»ç»“

- H5 è°ƒç”¨åŸç”Ÿé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š
  - ä¸€ç§æ˜¯é€šè¿‡è‡ªå®šä¹‰ URL Schemeï¼Œç”±åŸç”Ÿæ‹¦æˆª URL å¹¶æ‰§è¡Œå¯¹åº”é€»è¾‘ï¼Œé€‚åˆç®€å•çš„ä¸€æ¬¡æ€§æ“ä½œï¼›
  - å¦ä¸€ç§æ˜¯é€šè¿‡ JSBridgeï¼Œç”±åŸç”Ÿå‘ WebView æ³¨å…¥ JS å¯¹è±¡ï¼ŒH5 é€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨åŸç”Ÿæ–¹æ³•å¹¶æ¥æ”¶å¼‚æ­¥å›è°ƒï¼Œ
- JSBridge æ˜¯ç›®å‰ Hybrid åº”ç”¨ä¸­æ›´ä¸»æµã€æ›´ç¨³å®šçš„æ–¹æ¡ˆã€‚
