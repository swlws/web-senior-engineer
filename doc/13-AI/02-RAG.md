# RAG

## ä¸€ã€RAG æ˜¯ä»€ä¹ˆ

> RAG = ç”¨â€œå¯æ£€ç´¢çš„å¤–éƒ¨çŸ¥è¯†â€æ¥çº¦æŸå’Œå¢å¼º LLM çš„ç”Ÿæˆç»“æœ

æ ¸å¿ƒç›®æ ‡åªæœ‰ä¸¤ä¸ªï¼š

- å‡å°‘å¹»è§‰ï¼ˆHallucinationï¼‰
- è®©æ¨¡å‹å›ç­”â€œå®ƒåŸæœ¬ä¸çŸ¥é“çš„ã€ç§æœ‰çš„ã€å®æ—¶çš„çŸ¥è¯†â€

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ RAGï¼ˆLLM çš„å¤©ç„¶ç¼ºé™·ï¼‰

LLM æœ¬èº«å­˜åœ¨å‡ ä¸ªç¡¬ä¼¤ï¼š

| é—®é¢˜      | åŸå›                     |
| ------- | --------------------- |
| çŸ¥è¯†æœ‰æˆªæ­¢æ—¶é—´ | è®­ç»ƒæ•°æ®æ˜¯é™æ€çš„              |
| ä¸çŸ¥é“ç§æœ‰æ•°æ® | æ— æ³•ç›´æ¥è®¿é—®ä½ çš„ä»£ç åº“ / æ–‡æ¡£ / DB |
| å®¹æ˜“èƒ¡ç¼–    | æ¦‚ç‡æ¨¡å‹ï¼Œéäº‹å®å¼•æ“            |
| ä¸Šä¸‹æ–‡é•¿åº¦æœ‰é™ | å…¨å¡ prompt æˆæœ¬é«˜ã€æ•ˆæœå·®     |

ğŸ‘‰ RAG çš„æœ¬è´¨ï¼š

> æŠŠã€ŒæŸ¥èµ„æ–™ã€è¿™ä¸€æ­¥ï¼Œä»äººï¼Œäº¤ç»™ç³»ç»Ÿè‡ªåŠ¨å®Œæˆ

## ä¸‰ã€RAG çš„æ•´ä½“æ¶æ„ï¼ˆå·¥ç¨‹è§†è§’ï¼‰

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Q  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query ç†è§£  â”‚ â† rewrite / embedding
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Retriever â”‚ â† å‘é‡æ£€ç´¢ / å…³é”®è¯æ£€ç´¢
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context æ„å»ºâ”‚ â† chunk + rerank
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LLM     â”‚ â† prompt + context
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å››ã€RAG çš„æ ¸å¿ƒç»„æˆæ‹†è§£

### 1ï¸âƒ£ æ•°æ®æºï¼ˆKnowledge Baseï¼‰

å¸¸è§æ¥æºï¼š

- ğŸ“„ æ–‡æ¡£ï¼ˆMarkdown / PDF / Wordï¼‰
- ğŸ’» ä»£ç ä»“åº“ï¼ˆä½ ç°åœ¨åšçš„è¿™ä¸ªéå¸¸å…¸å‹ï¼‰
- ğŸ§  æ•°æ®åº“ï¼ˆä¸šåŠ¡è¡¨ã€é…ç½®è¡¨ï¼‰
- ğŸŒ å†…éƒ¨ API / OpenAPI

> å…³é”®ä¸æ˜¯â€œå­˜ä»€ä¹ˆâ€ï¼Œè€Œæ˜¯â€œæ€ä¹ˆæ‹†â€

### 2ï¸âƒ£ Chunkï¼ˆåˆ‡åˆ†ç­–ç•¥ï¼‰â€”â€”æˆè´¥å…³é”®

ä¸ºä»€ä¹ˆè¦åˆ‡ï¼Ÿ

- å‘é‡æ¨¡å‹æœ‰é•¿åº¦é™åˆ¶
- æ£€ç´¢ç²’åº¦å†³å®šå‘½ä¸­ç‡

å¸¸è§ç­–ç•¥

| ç­–ç•¥                    | é€‚ç”¨åœºæ™¯          |
| --------------------- | ------------- |
| å›ºå®šé•¿åº¦ï¼ˆ500~1000 tokensï¼‰ | é€šç”¨æ–‡æ¡£          |
| è¯­ä¹‰åˆ‡åˆ†ï¼ˆæ ‡é¢˜ / æ®µè½ï¼‰         | Markdownã€æŠ€æœ¯æ–‡æ¡£ |
| AST åˆ‡åˆ†                | ä»£ç ï¼ˆå‡½æ•° / ç±»çº§åˆ«ï¼‰  |
| æ»‘åŠ¨çª—å£                  | ä¸Šä¸‹æ–‡å¼ºä¾èµ–        |

> ğŸ‘‰ ä»£ç  RAG å¼ºçƒˆå»ºè®® AST çº§åˆ«
> ï¼ˆä½ å‰é¢åš [frontend-mcp-server](https://github.com/swlws/mcp-playground) DAG è§£æï¼Œæœ¬è´¨å·²ç»æ˜¯ RAG ä¸Šæ¸¸ï¼‰

### 3ï¸âƒ£ Embeddingï¼ˆå‘é‡åŒ–ï¼‰

```txt
Text Chunk â”€â”€> Embedding Model â”€â”€> Vector
```

Embedding å†³å®šï¼š

- ç›¸ä¼¼åº¦æ£€ç´¢è´¨é‡
- å¬å›ç‡ä¸Šé™

å¸¸è§å‘é‡åº“

| ç±»å‹    | ä¾‹å­                    |
| ----- | --------------------- |
| æœ¬åœ°    | FAISS                 |
| äº‘æœåŠ¡   | Pinecone / Weaviate   |
| DB æ‰©å±• | PostgreSQL + pgvector |
| æœç´¢å¼•æ“  | Elasticsearch         |

### 4ï¸âƒ£ Retrieverï¼ˆæ£€ç´¢å™¨ï¼‰

Retriever = ä»â€œæ‰€æœ‰ chunkâ€ä¸­æ‰¾åˆ°æœ€ç›¸å…³çš„ Top K

å¸¸è§æ–¹å¼

| ç±»å‹     | ç‰¹ç‚¹           |
| ------ | ------------ |
| å‘é‡æ£€ç´¢   | è¯­ä¹‰ç›¸ä¼¼         |
| BM25   | å…³é”®è¯å¼ºåŒ¹é…       |
| Hybrid | è¯­ä¹‰ + å…³é”®è¯ï¼ˆæ¨èï¼‰ |

å·¥ç¨‹å¸¸è§å†™æ³•ï¼š

```js
const docs = await retriever.retrieve(query, { topK: 5 })
```

### 5ï¸âƒ£ Rerankï¼ˆé‡æ’ï¼Œå¾ˆå¤šäººå¿½ç•¥ï¼‰

> å‘é‡å¬å› â‰  æœ€ç›¸å…³

Reranker ç”¨æ›´é‡çš„æ¨¡å‹é‡æ–°æ’åºï¼š

- Cross-Encoder
- LLM-based rerank

> æ•ˆæœï¼šğŸ‘‰ Top3 è´¨é‡æ˜¾è‘—æå‡

### 6ï¸âƒ£ Context æ„å»ºï¼ˆPrompt Engineeringï¼‰

ä¸æ˜¯â€œç›´æ¥æ‹¼æ¥â€ï¼Œè€Œæ˜¯ï¼š

```txt
ä½ æ˜¯ä¸€ä¸ª xxx ä¸“å®¶
ä»¥ä¸‹æ˜¯ä¸é—®é¢˜ç›¸å…³çš„èµ„æ–™ï¼š
[doc1]
[doc2]
...

è¯·åŸºäºä»¥ä¸Šå†…å®¹å›ç­”é—®é¢˜ï¼Œ
å¦‚æœèµ„æ–™ä¸­æ²¡æœ‰ç­”æ¡ˆï¼Œè¯·æ˜ç¡®è¯´æ˜â€œä¸çŸ¥é“â€
```

å…³é”®ç‚¹ï¼š

- å¼ºçº¦æŸï¼šåªèƒ½åŸºäº context
- é˜²æ­¢ LLM è‡ªç”±å‘æŒ¥

## äº”ã€RAG â‰  æœç´¢ + LLMï¼ˆå¸¸è§è¯¯è§£ï¼‰

| é”™è¯¯ç†è§£       | æ­£ç¡®ç†è§£             |
| ---------- | ---------------- |
| RAG å°±æ˜¯æŸ¥èµ„æ–™  | RAG æ˜¯å®Œæ•´çš„æ•°æ®ç®¡é“     |
| å‘½ä¸­ä¸€æ¬¡å°±è¡Œ     | å¤š chunk + rerank |
| Prompt æœ€é‡è¦ | æ•°æ®è´¨é‡ > Prompt    |
| æ¨¡å‹è¶Šå¤§è¶Šå¥½     | RAG å¯ä»¥ç”¨å°æ¨¡å‹       |

## å…­ã€RAG çš„è¿›é˜¶å½¢æ€ï¼ˆä½ åé¢ä¸€å®šä¼šç”¨åˆ°ï¼‰

### 1ï¸âƒ£ Multi-Query RAG

LLM å…ˆç”Ÿæˆå¤šä¸ªæŸ¥è¯¢ï¼š

```txt
Q â†’ Q1 / Q2 / Q3 â†’ åˆå¹¶æ£€ç´¢
```

ğŸ‘‰ æé«˜å¬å›ç‡

### 2ï¸âƒ£ Graph RAGï¼ˆä¸ä½  DAG éå¸¸è´´åˆï¼‰

- èŠ‚ç‚¹ï¼šå‡½æ•° / æ¨¡å— / æ–‡ä»¶
- è¾¹ï¼šä¾èµ– / è°ƒç”¨å…³ç³»

æ£€ç´¢ä¸åªæ˜¯â€œç›¸ä¼¼â€ï¼Œè€Œæ˜¯ï¼š

> æ²¿ä¾èµ–å›¾æ‰©å±•ä¸Šä¸‹æ–‡

è¿™å°±æ˜¯ä½ ç°åœ¨åšçš„ frontend-mcp-server + DAG + G6 å¯è§†åŒ– çš„é«˜çº§å½¢æ€ã€‚

### 3ï¸âƒ£ Agent + RAG

RAG ä½œä¸º Agent çš„ä¸€ä¸ª Toolï¼š

```ts
tools = {
  searchCode,
  readFile,
  queryDocs
}
```

Agent å†³å®šï¼š

- æ˜¯å¦éœ€è¦ RAG
- æŸ¥å“ªä¸€ç±»æ•°æ®
- æŸ¥å‡ æ¬¡

### ä¸ƒã€RAG åœ¨çœŸå®å·¥ç¨‹ä¸­çš„è½åœ°æ¨¡å¼

å…¸å‹åº”ç”¨

| åœºæ™¯          | RAG çš„ä½œç”¨     |
| ----------- | ----------- |
| ä»£ç é—®ç­”        | æŸ¥ repo + è§£é‡Š |
| æ¶æ„åˆ†æ        | æŸ¥ä¾èµ– + æ€»ç»“    |
| å†…éƒ¨çŸ¥è¯†åº“       | æ›¿ä»£ Wiki     |
| IDE Copilot | ç²¾å‡†ä¸Šä¸‹æ–‡       |

> ğŸ‘‰ ä½ ç°åœ¨åšçš„ MCP + VSCode é›†æˆï¼Œæœ¬è´¨å°±æ˜¯ RAG çš„ IDE åŒ–

## å…«ã€ä¸€ä¸ªæç®€ RAG ä¼ªä»£ç ï¼ˆå·¥ç¨‹ç‰ˆï¼‰

```ts
async function ragAnswer(question) {
  const embedding = await embed(question)

  const chunks = await vectorDB.search(embedding, 10)

  const context = rerank(chunks, question).slice(0, 5)

  return llm.generate({
    system: 'ä½ åªèƒ½åŸºäºæä¾›çš„èµ„æ–™å›ç­”',
    context,
    question
  })
}
```

## ä¹ã€ä»€ä¹ˆæ—¶å€™ä¸è¯¥ç”¨ RAG

- âŒ äº‹å®æ€§æå¼ºã€æ ‡å‡†ç­”æ¡ˆé—®é¢˜ï¼ˆå¦‚æ•°å­¦ï¼‰
- âŒ è¶…çŸ­ä¸Šä¸‹æ–‡å°±èƒ½è§£å†³çš„é—®é¢˜
- âŒ å®æ—¶å¼ºä¸€è‡´äº‹åŠ¡ï¼ˆRAG ä¸æ˜¯ DBï¼‰

## åã€è¿›é˜¶å»ºè®®

ä½ å¯ä»¥ç›´æ¥å¾€è¿™ 3 ä¸ªæ–¹å‘èµ°ï¼š

1. Code RAG + AST + DAG
2. Graph RAGï¼ˆå‡½æ•°ä¾èµ– / æ¨¡å—å½±å“åˆ†æï¼‰
3. Agent + MCP + RAGï¼ˆå·¥å…·é©±åŠ¨ï¼‰
