# PM2的负载均衡

在 PM2 中，如果你用 Cluster 模式启动多个进程，你可以让它们 共享同一个端口，而不需要每个进程绑定不同的端口。这是 Node.js Cluster API 的核心特性，PM2 正是基于它来实现多进程负载均衡的。

## 1️⃣ 原理

1. 主进程 + 工作进程（Master + Workers）
   - PM2 启动 Cluster 模式时，会创建一个 Master 进程。
   - Master 进程负责监听 TCP 端口。
   - Master 把收到的连接请求分发给 Worker（子进程）。
2. Worker 不直接监听端口
   - Worker 只处理 Master 分发来的请求。
   - 多个 Worker 同时存在，但外部只看到一个端口。
3. 负载均衡
   - Master 自动按 轮询（round-robin） 或操作系统调度，将请求分发到不同 Worker。
   - 这样多个进程可以共享同一个端口，同时处理更多并发请求。

## 2️⃣ PM2 配置示例（多进程共享端口）

```js
// ecosystem.config.cjs
module.exports = {
  apps: [
    {
      name: 'api-server',
      script: './dist/index.js',
      instances: 'max',        // 根据 CPU 核心数启动
      exec_mode: 'cluster',    // Cluster 模式
      env_production: {
        NODE_ENV: 'production',
        PORT: 3000            // 所有进程共享这个端口
      },
      max_memory_restart: '1G'
    }
  ]
};

```

然后启动：

```bash
pm2 start ecosystem.config.cjs --env production
```

- instances: 'max' → 每个 CPU 核心都会有一个 Worker
- exec_mode: 'cluster' → 启用 Cluster 模式，允许共享端口
- 所有 Worker 都使用相同的 PORT

## 3️⃣ Node.js 代码示例（Koa/Express）

你在 Worker 代码里不要手动调用 cluster，PM2 会帮你管理：

```js
const Koa = require('koa');
const app = new Koa();
const PORT = process.env.PORT || 3000;

app.use(async (ctx) => {
  ctx.body = `Hello from process ${process.pid}`;
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT} (pid: ${process.pid})`);
});
```

## 4️⃣ 核心总结

| 特性          | 说明                                             |
| ----------- | ---------------------------------------------- |
| Master 监听端口 | PM2 Cluster 模式下，Master 负责 TCP 端口               |
| Worker 处理请求 | Worker 进程只处理 Master 分发的请求                      |
| 共享端口        | 所有 Worker 使用相同端口，无需手动管理多个端口                    |
| 负载均衡        | Master 自动轮询或 OS 调度分发请求                         |
| 高可用         | 某个 Worker crash，PM2 自动重启，不影响 Master 和其他 Worker |

## ⚠️ 注意事项

- 只在 Cluster 模式下才能共享端口，Fork 模式每个进程都需要独立端口。
- 不要在应用里手动做 cluster.fork()，PM2 已经封装了。
- 多核处理能力 → 能充分利用 CPU，多进程处理高并发。
- Session / 内存状态 → 每个 Worker 内存独立，需要共享状态（如 session）要用 Redis 或数据库。
