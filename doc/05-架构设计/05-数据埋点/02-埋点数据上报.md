# 埋点数据上报

## 📡 常见的埋点数据上报方式

### 1. XMLHttpRequest / fetch

原理：通过 Ajax 请求把埋点数据发送到服务器。

优点：

- 可控性强，支持同步/异步、超时处理、失败重试。
- 兼容性好（XHR 老浏览器也支持）。

缺点：

- 页面关闭/跳转时，未完成的请求可能丢失。
- 需要开发封装，防止和业务请求混淆。

### 2. navigator.sendBeacon

原理：浏览器提供的专门用于 埋点/日志上报 的 API，在页面卸载时也能保证发送。

优点：

- 异步、非阻塞，不影响页面性能。
- 页面关闭/跳转时仍能发送成功（大优势）。

缺点：

- 只支持 POST，不支持 GET。
- 不支持自定义 header，功能有限。
- 兼容性：IE 不支持，现代浏览器 OK。

### 3. `<img src="...">` / 像素点上报

原理：动态创建一个 Image，通过 URL 查询参数把埋点数据拼接上传。

优点：

- 实现简单，无跨域限制（图片天然跨域）。
- 浏览器兼容性极好。

缺点：

- URL 长度受限（2KB~8KB），不适合大数据量。
- 只能上报，不能拿返回值。
- 不适合复杂场景（需要批量上报时很麻烦）。

### 4. `<script> / JSONP`

原理：动态插入 `<script>` 标签，利用 JSONP 机制上报数据。

优点：

- 兼容老旧浏览器。
- 能跨域上报。

缺点：

- 主要是老方案，现在几乎被淘汰。
- 安全性差，容易被 XSS 利用。

### 5. send via WebSocket

原理：通过 WebSocket 长连接，实时发送埋点数据。

优点：

- 实时性好，适合高频数据（如游戏、直播）。
- 可以批量压缩后统一传输。

缺点：

- 复杂度高，需要保持连接。
- 对前端/服务端性能要求高，不适合通用场景。

### 6. Service Worker 中转

原理：通过 Service Worker 拦截 & 缓存埋点请求，在合适时机批量发送。

优点：

- 可离线缓存，网络恢复时再上报。
- 可做批量聚合，减少请求数。

缺点：

- 实现复杂，需要额外逻辑。
- 对浏览器支持依赖较强（IE 不行）。

## 📊 总结对比表

| 方式               | 可靠性 | 性能影响 | 数据量   | 适用场景                         |
| ------------------ | ------ | -------- | -------- | -------------------------------- |
| **XHR / fetch**    | 中等   | 中       | 大数据可 | 常规埋点、业务请求               |
| **sendBeacon**     | 高     | 低       | 中等     | 页面关闭时上报、性能敏感场景     |
| **Image 打点**     | 中等   | 低       | 小数据   | 最简单的上报，兼容性好           |
| **Script / JSONP** | 中等   | 高       | 小数据   | 兼容旧浏览器（已过时）           |
| **WebSocket**      | 高     | 中高     | 大数据流 | 实时性要求高的场景（游戏、直播） |
| **Service Worker** | 高     | 低       | 大数据   | 离线埋点、批量上报               |
