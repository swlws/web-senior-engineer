# 接口高并发场景

处理接口高并发是后端架构设计中的核心问题之一。要根据业务场景选择不同的手段，通常会从 限流、防抖/节流、缓存、异步削峰、集群扩展 等方面综合处理。

## 一、常见高并发问题

- 服务崩溃：请求量超过服务器承载能力。
- 数据库压力大：大量请求直接访问数据库，导致连接耗尽或查询缓慢。
- 数据不一致/重复操作：如秒杀等场景，多个用户同时操作同一资源。
- 响应变慢：接口排队或阻塞，影响用户体验

## 二、应对高并发的常见手段

### 1. 限流（Rate Limiting）

控制单位时间内允许通过的请求数，防止瞬时流量冲垮系统。

- 令牌桶算法（Token Bucket）
- 漏桶算法（Leaky Bucket）
- 固定窗口/滑动窗口

📦 相关中间件：

- Nginx：limit_req_zone
- Spring Cloud Gateway / Kong / Traefik 等网关限流
- Redis + Lua 脚本实现滑动窗口限流

### 2. 缓存（Cache）

减少对数据库/慢接口的访问，提高响应速度。

- 本地缓存（如 Guava Cache）：适用于单机缓存
- 分布式缓存（如 Redis / Memcached）
  - 页面缓存（Whole page cache）
  - 接口缓存（如返回结果缓存）
  - 数据缓存（热点数据缓存）

🧠 注意：缓存要设置过期时间、避免缓存穿透、缓存击穿、缓存雪崩。

### 3. 异步 & 消息队列（MQ）

削峰填谷，避免请求高峰导致数据库/接口压力暴涨。

- 消息队列（如 Kafka / RabbitMQ / RocketMQ / Redis Stream）
  - 应用场景：下单、短信、邮件发送、日志落库等
- 异步任务队列（如 Node.js 的队列、Python 的 Celery）

### 4. 读写分离 + 数据库优化

- 主从分离：读请求走从库，写请求走主库
- 垂直拆分、水平分库分表（如按用户 ID 分库）
- 建立索引、优化慢 SQL、连接池管理

### 5. 集群与负载均衡

将压力分散到多台服务器上

- Nginx / LVS 负载均衡
- 服务注册与发现（如 Consul、Nacos）
- 容器化部署（如 Kubernetes + HPA 自动扩容）

### 6. 前端防抖/节流

如果客户端频繁发送请求，前端可以通过防抖（debounce）和节流（throttle）限制请求频率。

## 三、特定业务场景下的手段

### ✅ 秒杀系统

- 接口限流 + 验证码 + 排队
- 请求进消息队列异步处理
- Redis 预减库存 + 最终一致性 DB 更新
- 防止超卖、重复下单（幂等性）

### ✅ 高频查询接口

- Redis 缓存热点数据
- 使用布隆过滤器避免无效请求击穿缓存
- 分布式锁防止缓存击穿

## 四、监控和容错设计

- 熔断（如 Hystrix、Sentinel）
- 降级（返回默认数据或提示稍后再试）
- 实时监控（如 Prometheus + Grafana、ELK）

## 五、小结

| 分类       | 技术手段                               |
| ---------- | -------------------------------------- |
| 流控限速   | Nginx 限流、令牌桶、滑动窗口、网关限流 |
| 缓存优化   | Redis、页面缓存、接口缓存、CDN 加速    |
| 异步解耦   | 消息队列、事件驱动、后台任务处理       |
| 扩展能力   | 多节点部署、服务拆分、K8s 自动伸缩     |
| 数据库优化 | 分库分表、读写分离、索引优化           |
| 降级容错   | 熔断器、失败重试、兜底逻辑             |
