# PM2 启动多个进程共用一个端口是如何实现的

在 PM2 中，如果你用 Cluster 模式启动多个进程，你可以让它们 共享同一个端口，而不需要每个进程绑定不同的端口。这是 Node.js Cluster API 的核心特性，PM2 正是基于它来实现多进程负载均衡的。

## 1️⃣ 原理

1. 主进程 + 工作进程（Master + Workers）
   - PM2 启动 Cluster 模式时，会创建一个 Master 进程。
   - Master 进程负责监听 TCP 端口。
   - Master 把收到的连接请求分发给 Worker（子进程）。
2. Worker 不直接监听端口
   - Worker 只处理 Master 分发来的请求。
   - 多个 Worker 同时存在，但外部只看到一个端口。
3. 负载均衡
   - Master 自动按 轮询（round-robin） 或操作系统调度，将请求分发到不同 Worker。
   - 这样多个进程可以共享同一个端口，同时处理更多并发请求。

## 2️⃣ PM2 配置示例（多进程共享端口）

```js
// ecosystem.config.cjs
module.exports = {
  apps: [
    {
      name: "api-server",
      script: "./dist/index.js",
      instances: "max", // 根据 CPU 核心数启动
      exec_mode: "cluster", // Cluster 模式
      env_production: {
        NODE_ENV: "production",
        PORT: 3000, // 所有进程共享这个端口
      },
      max_memory_restart: "1G",
    },
  ],
};
```

然后启动：

```bash
pm2 start ecosystem.config.cjs --env production
```

- instances: 'max' → 每个 CPU 核心都会有一个 Worker
- exec_mode: 'cluster' → 启用 Cluster 模式，允许共享端口
- 所有 Worker 都使用相同的 PORT

## 3️⃣ Node.js 代码示例（Koa/Express）

你在 Worker 代码里不要手动调用 cluster，PM2 会帮你管理：

```js
const Koa = require("koa");
const app = new Koa();
const PORT = process.env.PORT || 3000;

app.use(async (ctx) => {
  ctx.body = `Hello from process ${process.pid}`;
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT} (pid: ${process.pid})`);
});
```

- 多个 Worker 会输出不同的 `process.pid`，但是都绑定在同一个 PORT。
- 外部访问 `http://localhost:3000`，请求会轮询分发到不同 Worker。
