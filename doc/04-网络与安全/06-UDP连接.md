# UDP 连接

UDP（User Datagram Protocol）是另一种常用的传输层协议，与 TCP 相对，它是无连接、面向报文、不保证可靠性的协议。

## 📌 一、UDP 是什么？

| 特性          | 描述                                     |
| ------------- | ---------------------------------------- |
| 无连接        | 不需要建立连接，直接发送数据             |
| 不可靠        | 不保证数据是否到达、不保证顺序           |
| 面向报文      | 报文独立，不做分片重组（交给应用层处理） |
| 较快          | 无握手，无连接维护开销                   |
| 支持广播/多播 | TCP 不支持                               |

## 🚫 二、UDP 没有“连接”过程

### ❗ 没有三次握手：

- TCP 在发送数据前，必须进行三次握手建立连接；
- UDP 直接发数据，不建立连接；
- “UDP 连接”本质上并不真实存在，只是应用层逻辑上的“一对一通信”。

### 示例流程（UDP 数据发送）：

```text
客户端应用 → 系统调用 sendto() → UDP 报文构造 → 加上 IP 头 → 发送
```

无需任何预处理，服务端只需监听端口接收报文即可。

## 📦 三、UDP 报文结构

UDP 报文头部结构仅有 8 字节，字段如下：

| 字段       | 长度   | 描述                                     |
| ---------- | ------ | ---------------------------------------- |
| 源端口号   | 2 字节 | 可选                                     |
| 目标端口号 | 2 字节 | 必填                                     |
| 长度       | 2 字节 | 包括头部和数据总长                       |
| 校验和     | 2 字节 | 可校验数据完整性（IPv4 可选，IPv6 强制） |

## 🧪 四、UDP 常见应用场景

| 场景                   | 原因                         |
| ---------------------- | ---------------------------- |
| 实时通信（视频、语音） | 低延迟要求高，能容忍部分丢包 |
| DNS 查询               | 请求-响应简单，适合无连接    |
| DHCP（动态 IP 分配）   | 广播支持，快速通信           |
| 游戏同步               | 频繁小数据包，不要求强一致性 |

## ⚠️ 五、UDP 的局限与处理方式

| 问题       | 说明                                 | 处理方法           |
| ---------- | ------------------------------------ | ------------------ |
| 丢包       | 网络拥塞或错误丢失                   | 应用层重传机制     |
| 顺序错乱   | 报文可能乱序                         | 应用层编号处理     |
| 粘包/拆包  | UDP 是报文边界清晰的，不存在粘包问题 | ✔ 无需处理         |
| 无连接维护 | 不知道对方是否在线                   | 应用层心跳保活机制 |

## 🧠 六、面试常考点对比（UDP vs TCP）

| 对比点   | TCP                | UDP                                    |
| -------- | ------------------ | -------------------------------------- |
| 是否连接 | 是（三次握手）     | 否                                     |
| 是否可靠 | 是（确认 + 重传）  | 否                                     |
| 是否有序 | 是                 | 否                                     |
| 速度     | 慢                 | 快                                     |
| 传输单位 | 字节流             | 报文                                   |
| 报文大小 | 无限（分片处理）   | 限制在 65,535 字节内，推荐 < 1472 字节 |
| 应用场景 | 文件传输、网页加载 | 视频通话、DNS、游戏同步                |

## ✅ 面试常问

1. UDP 为什么比 TCP 快？
   > 因为没有三次握手、没有连接状态、不做重传/排序。
2. UDP 不可靠还能用在哪些场景？
   > 实时性比可靠性更重要的场景，如直播、语音、在线游戏。
3. UDP 如何实现可靠传输？
   > 应用层自己实现：加序号 + 确认包 + 超时重发。
4. UDP 如何实现长连接？
   > 实际没有“连接”，但可以通过应用层标识或 socket 缓存维护状态。
5. UDP 支持广播吗？
   > 支持，适用于 DHCP、局域网通信等。

## 🧩 示例代码（Node.js）

```javascript
// UDP 服务端
const dgram = require("dgram");
const server = dgram.createSocket("udp4");

server.on("message", (msg, rinfo) => {
  console.log(`接收来自 ${rinfo.address}:${rinfo.port} 的消息: ${msg}`);
  server.send("pong", rinfo.port, rinfo.address);
});

server.bind(41234);
```
