# 点击量热力图

可视化的方式展示用户在页面 DOM 的点击量

## 实际业务价值

- 价值点1：排除低效无用需求。
  - 超 10 个不同部门的产品，问卷调研中表示在业务中均不同程度能减少低效需求。举例：销售行为分析，业务想给所有标签页面增加汇总和均值功能，但从热力图点击次数中发现，使用频次非常少，最终取消该低效需求。
- 价值点2：减少常规埋点需求。
  - 从需要产品收集、开发、查看约1-2天工作量，到缩短或无需工作量，直接查看。
  - 案例：超 4 个不同部门的产品或开发，问卷调研中确认已减少埋点开发量。
  - 举例：
    - CRM 客户管理的产品同学，要求前端给需要看点击数据的位置增加自定义埋点，后期推荐使用该热力图后取消了该需求。
    - 近期上线的反爬系统，由于接入热力图，也无需开发进行自定义埋点。
- 价值点3：调动并提高产品、开发等各个角色参与页面优化的意识。
  - 问卷调研或跨声反馈中，不少业务主管等同事反馈认可该数据，表示该热力图可以辅助他们跟进功能使用情况，进行功能下线或改配策略。
-价值点4：提高前端开发创新意识。该项目已分别获得 1 个GUI外观专利奖，1 个发明专利奖。

## 落地实现

- 数据来源。友盟 APM 的点击量数据
- 数据统计维度。
  - 页面维度。
  - 组织
  - 人员
  - 时间
- 数据展示形式。
  - 热力图

## 前端问题点

### 数据过滤

- 过滤掉 DOM 过小、DOM 过大的元素
- 数据聚合
  - 针对 DOM 过小的元素、且有实际意义的 DOM，在其父级 DOM 上添加标记，

### 绘制背景图

- [rsify/pico](https://github.com/rsify/pico?utm_source=chatgpt.com)
  一个轻量的、基于 SVG + foreignObject 实现的库。因为轻量，可以高度魔改，满足不同需求。
- Puppeteer / Headless Chrome
  服务端方案，灵活但需额外环境、资源占用高；并不适合运行在客户端。
- html2canvas
  客户端纯 JS 替代方案，更成熟，但渲染 fidelity（尤其是字体、视频、Canvas）不如 Pico。
- dom-to-image / html-to-image
  常用库，兼容性较好，但有时在复杂内容下表现有限，比如对 WebFonts 或高级 CSS 支持较弱。

基于 Pico 实现，过程中存在的问题：

1. WebComponent 兼容处理。
   new XMLSerializer().serializeToString(Node) 无法获取 WebComponent 的内容。需要特殊处理为普通 DOM + scoped CSS

### 绘制热力图

- [heatmap.js](https://github.com/pa7/heatmap.js)

问题点：

1. 数据量大时
   1. WebWorker 中执行数据裁剪、数据聚合
   2. 做切片渲染，避免长任务导致的卡顿
2. 体验优化
   1. 整个过程包括，后端拉取数据、前端数据裁剪聚合、绘制背景图、绘制热力图。添加 loading 效果。

## 性能优化

优化前，全流程绘制耗时：

||第一次(ms)|第二次(ms)|第三次(ms)|第四次(ms)|第五次(ms)|均值(ms)|
|-|-|-|-|-|-|-|
|网络+热力图+描边 + 数值|4861|4728|4833|4943|5100||
|网络开销|549|482|479|462|449||
|描边 + 数值| 4312 | 4246 | 4354 | 4481 | 4651 | 4408 |

优化后，分场景、分批次绘制耗时：

| 场景                | 第一次 | 第二次 | 第三次 | 第四次 | 第五次 | 均值  |
|---------------------|--------|--------|--------|--------|--------|-------|
| 网络 + 描边 + 数值  | 2585   | 3039   | 2676   | 2639   | 2574   |       |
| └ 网络开销          | 523    | 899    | 513    | 564    | 473    |       |
| 描边 + 数值         | 2062   | 2140   | 2163   | 2075   | 2101   | 2108  |
| 网络 + 热力图 + 数值| 3305   | 3170   | 2816   | 2763   | 2814   |       |
| └ 网络开销          | 679    | 1030   | 698    | 606    | 525    |       |
| 热力图 + 数值       | 2626   | 2140   | 2118   | 2157   | 2289   | 2266  |
