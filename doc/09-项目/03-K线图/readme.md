# K 线图

## 背景

以蜡烛图的方式展示股票信息，主要图表包分 K 图、日 K 图、周 K 图、月 K 图

## 方案设计

基于 ECharts 的 K 线图实现，图表绘制。支持：

- 数据初始化渲染
- 实时渲染

## 业务功能点

- 业务功能配置化，支持的业务功能：
  - 左右 Y 周的 Lable 配置化
  - 均线配置化
  - 标准 K 线与俗 K 线切换
  - 双击下钻功能配置化
  - 极值点配置化
    - 显示/隐藏
    - 文案
- 双击下钻
  - 详情模式时，切换到下一级 K 线图
  - 探矿模式时，弹出下一级 K 线图弹框
- 悬浮展示 tooltip
  - tooltip 的定位，支持空白区检测
- 滚轮缩放
  - 更新图表数据
  - 更新坐标系信息
    - X 轴日期
    - Y 轴刻度

## 问题点

### 1. 性能问题

- ECharts 的 API setOption，配置做增量更新
- ECHarts 的数据源添加 `__ec_primitive__` 字段，规避 ECharts 底层的 `deepClone`
- 绘制的主流成中，仅在最后触发一次 `setOption`
- 绘制图表
  - 高优先级。绘制 K 线图、量主图
  - 中优先级。绘制均量图
  - 低优先级。绘制昨日均线、买卖点
- 实时场景
  - Web Woker 中做数据合并
  - 更新函数，节流处理

### 2. 四点定位

鼠标在蜡烛图上悬浮时，当距离四点（开盘、收盘、最高、最低）的距离小于 10px 时，十字准线自动吸附到最近的点上

基于 updateAxisPointer 这个 action 实现。

> 备注：官方文档中没有介绍这个 action，但是 ECharts 源码中，有使用这个 action。

### 3. tooltip 定位到空白区

需求：tooltip 不能遮挡蜡烛图，除非实在没有空白区域了，才允许遮挡。

ECharts 的 tooltip 配置项，有个参数 position，支持动态设置 tooltip 的定位位置。

空白区检测算法原理：

1. 获取可视区每个蜡烛图的宽度，以及最高点、最低点的坐标
2. 计算 tooltip 占据 N 个柱子的宽度
3. 在鼠标的左上、右上、左下、右下四个位置，找到合适的空白区域，放置 tooltip

### 4. 极值点碰撞检测

需求：多条线时，他们的极值点，不能重叠。

算法原理：

1. 获取所有的极值点，按照 X 轴坐标排序
2. 默认第一个点的位置是确认的，不需要调整
3. 遍历第 [1, N] 个极值点，判断 M 个极值点是否与 [0, M -1] 个点重叠
   - 都不重叠时，当前点的位置是确认的，不需要调整
   - 有重叠时，调整位置。然后重复第 3 步，直到所有点的位置都确定

## 质量管理

### 如何确认再次发生了性能问题

1. 代码规范
   - 遵循 setOption 增量更新的规范
   - 减少 setOption 调用次数
2. 上报埋点数据
   - 网络数据拉取耗时
   - 数据合并耗时
   - 渲染耗时
     - 高优先级任务耗时
     - 中优先级任务耗时
     - 低优先级任务耗时
