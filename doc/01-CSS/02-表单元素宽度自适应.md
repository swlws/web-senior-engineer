# 表单元素宽度自适应

## CSS 属性实现

```html
<input type="text" placeholder="请输入内容" />
<textarea placeholder="请输入内容"></textarea>

input, textarea { 
 field-sizing: content;
}
```

## JS 实现

### DOM 镜像

核心思路：

- 创建一个不可见的 `<span>`，样式与输入框一致
- 将输入内容同步给 `<span>`
- 读取 span.offsetWidth 作为 input 宽度
- 给 input 设置实际宽度

### 使用 ch 单位（简单但不完全准确）

```html
<input type="text" style="width: calc(1ch * 10);" />
```

动态调整：

```js
input.style.width = `${input.value.length}ch`;
```

⚠ 限制：

- 对于中文/emoji 不准确
- 字体非等宽时不准
- 适合英文场景。

### CANVAS 实现

```js
/**
 * 提取表单元素的字体样式
 * @param {*} formElement
 * @returns
 */
// eslint-disable-next-line no-unused-vars
function extractFontStyle(formElement) {
  const computedStyle = window.getComputedStyle(formElement)
  // 获取 input 的字体样式
  const font = [
    computedStyle.fontStyle,
    computedStyle.fontVariant,
    computedStyle.fontWeight,
    computedStyle.fontSize,
    computedStyle.fontFamily
  ].join(' ')

  return font
}

/**
 * 获取 canvas 上下文
 * @returns
 */
function getCanvasContext() {
  const canvas = getCanvasContext._canvas || (getCanvasContext._canvas = document.createElement('canvas'))
  return canvas.getContext('2d')
}

const DEFAULT_FONT =
  '14px BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", STHeiti, "Microsoft Yahei", Tahoma, Simsun, sans-serif'

/**
 * 计算 van-field 输入内容的像素宽度（基于 canvas.measureText）
 *
 * @param {Object} options 配置参数
 * @param {string} options.valueString - 输入框的当前值
 * @param {number} [options.maxWidth] - 最大宽度（单位 px，可选）
 * @param {number} [options.minWidth] - 最小宽度（单位 px，可选）
 * @param {number} [options.extra] - 额外补充的宽度（单位 px，可选）
 * @param {string} [options.font] - 字体样式（可选）
 * @returns {null|number} 返回测量得到的宽度（像素值）
 */
export function calcComponentWidth({
  valueString,
  maxWidth = 240,
  minWidth = 40,
  extra = 0,
  font = DEFAULT_FONT
} = {}) {
  if (valueString === null || valueString === undefined) return null
  valueString = String(valueString)
  if (!valueString) return null

  // 测量文字宽度
  const ctx = getCanvasContext()
  ctx.font = font
  const textMetrics = ctx.measureText(valueString)

  const textWidth = textMetrics.width + extra
  return Math.ceil(Math.min(Math.max(textWidth, minWidth), maxWidth))
}
```
