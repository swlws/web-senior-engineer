# Diff 算法

React 的 diff 算法是其高性能更新 UI 的核心，它通过虚拟 DOM 的比较，在“最小成本”下将新状态映射到真实 DOM 上。

## 🧠 核心思想

React diff 算法基于以下两大前提假设进行优化（也称为局部最优策略）：

1. 同级比较：只会对同一层级的节点进行比较，而不会跨层级移动节点。
2. key 提高复用：对同级子节点列表使用 key 标识，优化最小移动路径。

## 🔄 React diff 的三种类型

React diff 可以分为 3 类：

| 类型          | 描述                                              |
| ------------- | ------------------------------------------------- |
| 元素节点 diff | 比较元素类型（标签）是否相同                      |
| 属性 diff     | 比较 props 差异，决定是否更新                     |
| 子节点 diff   | 对 children 数组做列表比较，查找最小 DOM 操作路径 |

## 💡 元素节点 diff

### 同类型节点（例如 <div> → <div>）

- 保留 DOM 节点
- 更新属性（props）
- 递归更新子节点

### 不同类型节点（例如 <div> → <span>）

- 删除旧节点及子树
- 挂载新节点及其子树

## 🧩 Props diff（属性比较）

遍历新旧 props：

- 如果属性被删除 → 调用 removeAttribute
- 如果属性被更改 → 更新属性值
- 如果属性未变 → 跳过

## 📚 Children diff：列表节点比较（重点）

### ❌ 最慢方式（不可接受）

用 O(n³) 的树对比（暴力比较每个节点的位置和内容） → 太慢！

### ✅ React 采用 O(n) 的优化策略：

- 如果子节点无 key：
  - 默认按索引一一比较
  - 若发现类型不一致，就销毁旧节点，新建新节点
- 如果子节点有 key：
  - 用 key 做索引，构建旧节点的映射表 { key: oldVNode }
  - 遍历新列表：
    - 如果 key 存在 → 复用并更新
    - 不存在 → 创建新节点
  - 遍历旧列表：
    - 若旧节点在新列表中没出现 → 删除节点
    - 最后判断是否需要移动节点（按索引顺序判断）

### ✳️ 最长递增子序列（LIS）

- 用于判断哪些节点可以“复用并保持原地不动”，剩下的才是需要移动的
- 移动次数 = 新列表长度 - LIS 长度

## ✅ 示例对比（带 key）

旧列表：

```js
[{ key: "a" }, { key: "b" }, { key: "c" }];
```

新列表:

```js
[{ key: "b" }, { key: "a" }, { key: "d" }];
```

操作：

- b 和 a 可复用（但位置变了，需要移动）
- c 被删除
- d 是新增

## 🔧 React diff 实际调用栈

React 内部实现流程（以 Fiber 架构为例）：

```js
beginWork → reconcileChildren → reconcileSingleElement / reconcileChildrenArray → placeChild → completeWork
```

其中：

- reconcileChildren 是核心入口
- reconcileChildrenArray 实现列表 diff
- placeChild 判断是否需要移动节点

## 🔬 关键优化点

| 技术点         | 说明                               |
| -------------- | ---------------------------------- |
| Fiber 架构     | 将渲染过程拆分成可以中断的任务单元 |
| key            | 用于高效判断节点复用和移动         |
| 最长递增子序列 | 减少节点移动次数，提升性能         |
| update queue   | React 会记录每次变更，合并调度     |

## 📌 总结

| 内容          | 要点                               |
| ------------- | ---------------------------------- |
| 算法本质      | 虚拟 DOM 树的比较，映射到真实 DOM  |
| 优化策略      | 同层比较 + key 匹配 + LIS 移动最少 |
| Diff 场景分类 | 节点类型 → props → children        |
| 使用建议      | 使用 key 且稳定（避免 index）      |
